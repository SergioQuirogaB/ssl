<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Koncilia SSL</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.32/sweetalert2.all.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.32/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body class="bg-gray-50">

    <!-- Header para monitor de certificados SSL con Tailwind -->
    <header class="bg-gradient-to-r from-blue-600 to-blue-800 shadow-md">
        <div class="container mx-auto px-4 py-6">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <!-- Secci√≥n del t√≠tulo y logo -->
                <div class="flex items-center space-x-4 mb-4 md:mb-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                        <path d="M8 11l3 3 5-5"></path>
                    </svg>
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-white">
                            Monitor de Certificados SSL
                        </h1>
                        <p class="text-sm md:text-base text-blue-100">
                            Supervisa el estado de tus certificados de seguridad
                        </p>
                    </div>
                </div>

                <!-- Estado del Sistema -->
                <div class="flex flex-col items-end space-y-2">
                    <div class="flex items-center space-x-4">
                        <span class="flex items-center bg-blue-900 bg-opacity-50 text-blue-100 px-3 py-1 rounded-full text-sm">
                            <span class="w-2 h-2 rounded-full bg-lime-400 mr-2"></span>
                            Monitoreo activo
                        </span>
                    </div>
                    <div class="text-sm text-blue-100">
                        <span id="lastUpdate" class="mr-4">√öltima actualizaci√≥n: --:--</span>
                        <span id="nextCheck">Pr√≥xima verificaci√≥n: --:--</span>
                    </div>
                </div>
            </div>
        </div>
    </header>  

    <div class="container mx-auto px-4 py-8">
        <!-- Resumen de Estado -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                <div class="text-sm text-gray-500">Total Dominios</div>
                <div id="totalDomains" class="text-2xl font-bold text-blue-600">0</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                <div class="text-sm text-gray-500">Certificados Activos</div>
                <div id="activeCerts" class="text-2xl font-bold text-green-600">0</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                <div class="text-sm text-gray-500">Pr√≥ximos a Vencer</div>
                <div id="expiringCerts" class="text-2xl font-bold text-yellow-600">0</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                <div class="text-sm text-gray-500">Certificados Offline</div>
                <div id="offlineCerts" class="text-2xl font-bold text-red-600">0</div>
            </div>
        </div>

        <div class="flex flex-col md:flex-row justify-between gap-4 mt-6 mb-6">
            <div class="flex-grow">
                <div class="flex">
                    <input type="text" id="domainInput" class="w-96 px-4 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-s" placeholder="Ingrese el dominio">
                    <button class="bg-gradient-to-r from-blue-600 to-blue-800 shadow-md text-white px-4 py-2 rounded-r-md transition duration-200 flex items-center justify-center" onclick="addDomain()">
                        <span class="text-white">Agregar</span>
                    </button>
                </div>                
            </div>
            <div>
                <button class="bg-red-400 hover:bg-red-500 text-white px-4 py-2 rounded-md transition duration-200 flex items-center gap-2" onclick="downloadReport()">
                   <strong>üìÑ PDF</strong>
                </button>                
            </div>
        </div>

        <!-- Buscador y filtros -->
        <div class="flex flex-col md:flex-row gap-4 mb-6">
            <div class="flex-grow">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <svg class="w-4 h-4 text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
                        </svg>
                    </div>
                    <input type="search" id="searchInput" class="block w-full p-2 pl-10 text-sm border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Buscar dominios...">
                </div>
            </div>
            <div class="flex gap-2">
                <select id="statusFilter" class="bg-white border border-gray-300 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                    <option value="all">Todos</option>
                    <option value="online">Online</option>
                    <option value="offline">Offline</option>
                </select>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full border-collapse" id="domainList">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="p-4 text-center text-sm font-bold w-16">Estado</th>
                        <th class="p-4 text-center text-sm font-bold w-32">Dominio ‚áÖ</th>
                        <th class="p-4 text-center text-sm font-bold w-32">V√°lido desde ‚áÖ</th>
                        <th class="p-4 text-center text-sm font-bold w-32">V√°lido hasta ‚áÖ</th>
                        <th class="p-4 text-center text-sm font-bold w-28">D√≠as rest. ‚áÖ</th>
                        <th class="p-4 text-center text-sm font-bold w-32">√ölt. verif ‚áÖ</th>
                        <th class="p-4 text-center text-sm font-bold w-32">Observaciones</th>
                        <th class="p-4 text-center text-sm font-bold w-2">Acci√≥n</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <footer class="bg-white border-t border-gray-200">
        <div class="container mx-auto px-5 py-8">
            <div class="flex flex-col sm:flex-row items-center">
                <p class="text-sm text-gray-500 sm:ml-4 sm:pl-4 sm:border-l-2 sm:border-gray-200 sm:py-2 sm:mt-0 mt-4">
                    ¬© <span id="currentYear"></span> <a href="https://koncilia.com" class="text-blue-900 hover:text-blue-700 transition-colors" target="_blank"><strong><span class="text-sky-500">K</span>oncilia</strong></a> ‚Äî
                    <a href="https://github.com/SergioQuirogaB" class="text-gray-600 ml-1 hover:text-blue-600 transition-colors" rel="noopener noreferrer" target="_blank">Versi√≥n. 4.0</a>
                </p>
            </div>
        </div>
    </footer>

    <script>
        // Variable global para almacenar los datos de dominios
        let domainsData = {};

        function updateDomainList() {
            fetch('/api/get_domains')
                .then(response => response.json())
                .then(domains => {
                    // Guardar datos en variable global
                    domainsData = domains;
                    renderDomainList();
                    
                    // Actualizar resumen
                    updateSummary(domains);
                    
                    // Disparar evento para notificar que la lista se ha actualizado
                    document.dispatchEvent(new CustomEvent('domainListUpdated'));
                })
                .catch(error => console.error('Error fetching domains:', error));
        }

        function updateSummary(domains) {
            const totalDomains = Object.keys(domains).length;
            const activeCerts = Object.values(domains).filter(info => info.has_ssl).length;
            const expiringCerts = Object.values(domains).filter(info => info.has_ssl && info.days_remaining <= 10).length;
            const offlineCerts = Object.values(domains).filter(info => !info.has_ssl).length;

            document.getElementById('totalDomains').textContent = totalDomains;
            document.getElementById('activeCerts').textContent = activeCerts;
            document.getElementById('expiringCerts').textContent = expiringCerts;
            document.getElementById('offlineCerts').textContent = offlineCerts;

            // Actualizar timestamp de √∫ltima actualizaci√≥n
            const now = new Date();
            const timeString = now.toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit'
            });
            document.getElementById('lastUpdate').textContent = `√öltima actualizaci√≥n: ${timeString}`;

            // Calcular pr√≥xima verificaci√≥n (3 minutos despu√©s)
            const nextCheck = new Date(now.getTime() + 3 * 60000);
            const nextCheckString = nextCheck.toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit'
            });
            document.getElementById('nextCheck').textContent = `Pr√≥xima verificaci√≥n: ${nextCheckString}`;
        }

        function renderDomainList() {
            const domainList = document.querySelector('#domainList tbody');
            domainList.innerHTML = '';
            
            // Obtener filtros
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            
            // Obtener notas guardadas
            const savedNotes = JSON.parse(localStorage.getItem('domainNotes') || '{}');
            
            for (const [domain, info] of Object.entries(domainsData)) {
                // Aplicar filtro de b√∫squeda
                if (searchTerm && !domain.toLowerCase().includes(searchTerm)) {
                    continue;
                }
                
                // Aplicar filtro de estado
                if (statusFilter === 'online' && !info.has_ssl) {
                    continue;
                }
                if (statusFilter === 'offline' && info.has_ssl) {
                    continue;
                }
                
                const row = document.createElement('tr');
                row.className = "border-b hover:bg-gray-50 transition-colors";
                
                if (info.has_ssl) {
                    row.innerHTML = `
                        <td class="p-4 align-middle text-sm text-center"><span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-lime-500 text-white">Online</span></td>
                        <td class="p-4 align-middle text-sm text-center">${domain}</td>
                        <td class="p-4 align-middle text-sm text-center">${info.valid_from}</td>
                        <td class="p-4 align-middle text-sm text-center">${info.valid_until}</td>
                        <td class="p-4 align-middle text-center">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                                info.days_remaining <= 3 ? 'bg-red-200 text-red-800' :
                                info.days_remaining <= 5 ? 'bg-orange-200 text-orange-800' :
                                info.days_remaining <= 10 ? 'bg-yellow-200 text-yellow-800' :
                                'bg-blue-200 text-blue-800'
                            }">
                                ${info.days_remaining} d√≠as
                            </span>
                        </td>
                        <td class="p-4 align-middle text-sm text-gray-600 text-center">${info.last_check}</td>
                        <td class="p-4 align-middle text-sm text-gray-600 text-center">
                            <input 
                                type="text" 
                                class="w-full border rounded px-2 py-1 text-sm text-gray-600 text-center focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                onchange="updateNotes('${domain}', this.value)" 
                                value="${savedNotes[domain] || info.note || ''}"
                            />
                        </td>
                        <td class="p-4 align-middle flex items-center justify-center">
                            <button onclick="confirmDelete('${domain}')" aria-label="Eliminar" class="hover:opacity-75 transition-opacity">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-red-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> 
                                    <polyline points="3 6 5 6 21 6"></polyline> 
                                    <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6m5 0V4a2 2 0 0 1 2-2h0a2 2 0 0 1 2 2v2"></path> 
                                    <line x1="10" y1="11" x2="10" y2="17"></line> 
                                    <line x1="14" y1="11" x2="14" y2="17"></line> 
                                </svg>
                            </button>
                        </td>
                    `;
                } else {
                    row.innerHTML = `
                        <td class="p-4 align-middle text-sm"><span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-500 text-white">Offline</span></td>
                        <td class="p-4 align-middle text-sm text-center">${domain}</td>
                        <td colspan="3" class="p-4 align-middle text-gray-700 text-sm"></td>
                        <td class="p-4 align-middle text-sm text-gray-600 text-center">${info.last_check}</td>
                        <td class="p-4 align-middle text-sm text-gray-600 text-center">
                            <input 
                                type="text" 
                                class="w-full border rounded px-2 py-1 text-sm text-gray-600 text-center focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                onchange="updateNotes('${domain}', this.value)" 
                                value="${savedNotes[domain] || info.note || ''}"
                            />
                        </td>
                        <td class="p-4 align-middle">
                            <button onclick="confirmDelete('${domain}')" aria-label="Eliminar" class="hover:opacity-75 transition-opacity">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-red-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> 
                                    <polyline points="3 6 5 6 21 6"></polyline> 
                                    <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6m5 0V4a2 2 0 0 1 2-2h0a2 2 0 0 1 2 2v2"></path> 
                                    <line x1="10" y1="11" x2="10" y2="17"></line> 
                                    <line x1="14" y1="11" x2="14" y2="17"></line> 
                                </svg>
                            </button>
                        </td>
                    `;
                }
                domainList.appendChild(row);
            }
        }

        // Funci√≥n para actualizar la vista en tiempo real
        function startRealTimeUpdates() {
            // Actualizar cada 3 minutos (180000 ms)
            setInterval(updateDomainList, 180000);
            
            // Actualizar cada minuto para el campo "√ölt. Verif"
            setInterval(() => {
                const now = new Date();
                const timeString = now.toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit' 
                });
                
                // Actualizar solo el campo "√ölt. Verif" en todas las filas
                const rows = document.querySelectorAll('#domainList tbody tr');
                rows.forEach(row => {
                    const lastCheckCell = row.querySelector('td:nth-child(6)');
                    if (lastCheckCell) {
                        lastCheckCell.textContent = timeString;
                    }
                });
            }, 60000); // Actualizar vista de Ult. Verif cada minuto
        }

        // Cargar dominios guardados al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            const savedDomains = JSON.parse(localStorage.getItem('monitoredDomains') || '[]');
            
            // Restaurar dominios guardados
            savedDomains.forEach(domain => {
                fetch('/api/add_domain', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ domain })
                });
            });

            // Iniciar actualizaciones
            updateDomainList();
            startRealTimeUpdates();
            
            // Configurar el ordenamiento de tabla
            setupTableSorting();
            
            // Configurar eventos para filtros
            document.getElementById('searchInput').addEventListener('input', renderDomainList);
            document.getElementById('statusFilter').addEventListener('change', renderDomainList);
        });

        function addDomain() {
            const domain = document.getElementById('domainInput').value.trim();
            if (!domain) return;
            
            // Verificar duplicados antes de agregar
            const savedDomains = JSON.parse(localStorage.getItem('monitoredDomains') || '[]');
            
            if (savedDomains.includes(domain)) {
                Swal.fire({
                    title: 'Dominio duplicado',
                    text: `El dominio ${domain} ya est√° siendo monitoreado.`,
                    icon: 'warning',
                    confirmButtonColor: '#84CC16'
                });
                return;
            }
            
            // Si no hay duplicados, guardar en localStorage y agregar
            savedDomains.push(domain);
            localStorage.setItem('monitoredDomains', JSON.stringify(savedDomains));

            fetch('/api/add_domain', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ domain })
            })
            .then(response => response.json())
            .then(() => {
                document.getElementById('domainInput').value = '';
                updateDomainList();
                Swal.fire({
                    title: 'Dominio agregado',
                    text: `El dominio ${domain} ha sido agregado al monitoreo.`,
                    icon: 'success',
                    confirmButtonColor: '#84CC16',
                    timer: 1500,
                    showConfirmButton: false
                });
            });
        }

        // Funci√≥n para confirmar la eliminaci√≥n con SweetAlert
        function confirmDelete(domain) {
            Swal.fire({
                title: '¬øEst√°s seguro?',
                text: `¬øDeseas eliminar el dominio ${domain} del monitoreo?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#84CC16',
                cancelButtonColor: '#E14A4A',
                confirmButtonText: 'S√≠, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    removeDomain(domain);
                    Swal.fire(
                        '¬°Eliminado!',
                        `El dominio ${domain} ha sido eliminado del monitoreo.`,
                        'success'
                    );
                }
            });
        }

        function removeDomain(domain) {
            // Eliminar del almacenamiento local antes de eliminar
            const savedDomains = JSON.parse(localStorage.getItem('monitoredDomains') || '[]');
            const updatedDomains = savedDomains.filter(d => d !== domain);
            localStorage.setItem('monitoredDomains', JSON.stringify(updatedDomains));

            // Eliminar tambi√©n la nota asociada
            const savedNotes = JSON.parse(localStorage.getItem('domainNotes') || '{}');
            delete savedNotes[domain];
            localStorage.setItem('domainNotes', JSON.stringify(savedNotes));

            fetch('/api/remove_domain', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ domain })
            })
            .then(() => updateDomainList());
        }

        function updateNotes(domain, value) {
            // Guardar la observaci√≥n en localStorage
            const savedNotes = JSON.parse(localStorage.getItem('domainNotes') || '{}');
            savedNotes[domain] = value;
            localStorage.setItem('domainNotes', JSON.stringify(savedNotes));

            // Enviar al servidor
            fetch('/api/update_notes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ domain: domain, note: value })
            })
            .then(response => response.json())
            .catch(error => console.error('Error actualizando nota:', error));
        }

        function downloadReport() {
            fetch('/api/get_domains')
                .then(response => response.json())
                .then(domains => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');

                    // Agrega encabezado y el t√≠tulo
                    doc.setFontSize(15);
                    doc.setTextColor(12, 23, 145);
                    doc.text('Reporte de Certificados SSL', 105, 20, { align: 'center' });
                    
                    // Agrega la fecha
                    doc.setFontSize(10);
                    doc.setTextColor(100);
                    const date = new Date().toLocaleDateString('es-ES', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    doc.text(`Fecha del reporte: ${date}`, 105, 30, { align: 'center' });

                    // Crear contenedores para los gr√°ficos
                    const canvasContainer = document.createElement('div');
                    canvasContainer.style.position = 'absolute';
                    canvasContainer.style.left = '-9999px';
                    canvasContainer.style.width = '800px';
                    canvasContainer.style.height = '400px';
                    document.body.appendChild(canvasContainer);

                    // Crear gr√°fico de estados
                    const statusCanvas = document.createElement('canvas');
                    statusCanvas.width = 400;
                    statusCanvas.height = 200;
                    canvasContainer.appendChild(statusCanvas);

                    const statusCtx = statusCanvas.getContext('2d');
                    const validDomains = Object.values(domains).filter(info => info.has_ssl).length;
                    const invalidDomains = Object.values(domains).filter(info => !info.has_ssl).length;

                    const statusChart = new Chart(statusCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Online', 'Offline'],
                            datasets: [{
                                data: [validDomains, invalidDomains],
                                backgroundColor: ['#1E40AF', '#93C5FD'],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Distribuci√≥n de Estados SSL',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                }
                            }
                        }
                    });

                    // Crear gr√°fico de d√≠as restantes
                    const daysCanvas = document.createElement('canvas');
                    daysCanvas.width = 400;
                    daysCanvas.height = 200;
                    canvasContainer.appendChild(daysCanvas);

                    const daysCtx = daysCanvas.getContext('2d');
                    const daysData = Object.values(domains)
                        .filter(info => info.has_ssl)
                        .map(info => info.days_remaining)
                        .sort((a, b) => a - b);

                    const daysChart = new Chart(daysCtx, {
                        type: 'bar',
                        data: {
                            labels: Array(daysData.length).fill(''),
                            datasets: [{
                                label: 'D√≠as Restantes',
                                data: daysData,
                                backgroundColor: daysData.map(days => 
                                    days <= 3 ? '#1E40AF' :
                                    days <= 5 ? '#3B82F6' :
                                    days <= 10 ? '#60A5FA' :
                                    '#93C5FD'
                                ),
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'D√≠as Restantes por Certificado',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Certificados',
                                        font: {
                                            size: 12,
                                            weight: 'bold'
                                        }
                                    }
                                }
                            }
                        }
                    });

                    // Esperar a que los gr√°ficos se rendericen completamente
                    setTimeout(() => {
                        // Convertir gr√°ficos a im√°genes y agregarlos al PDF
                        Promise.all([
                            html2canvas(statusCanvas, {
                                scale: 2,
                                useCORS: true,
                                backgroundColor: '#ffffff'
                            }),
                            html2canvas(daysCanvas, {
                                scale: 2,
                                useCORS: true,
                                backgroundColor: '#ffffff'
                            })
                        ]).then(([statusImage, daysImage]) => {
                            // Calcular posiciones centradas para los gr√°ficos
                            const pageWidth = doc.internal.pageSize.width;
                            const graphWidth = 95;
                            const graphHeight = 47.5;
                            const leftMargin = (pageWidth - (graphWidth * 2 + 10)) / 2 - 15;

                            // Agregar gr√°fico de estados
                            doc.addImage(statusImage.toDataURL('image/png'), 'PNG', leftMargin, 40, graphWidth, graphHeight);
                            
                            // Agregar gr√°fico de d√≠as restantes
                            doc.addImage(daysImage.toDataURL('image/png'), 'PNG', leftMargin + graphWidth + 10, 40, graphWidth, graphHeight);

                            // Tabla del reporte
                            const tableWidth = 190;
                            const centerMargin = (pageWidth - tableWidth) / 2;

                            // Obtener el orden actual de la tabla
                            const tableRows = Array.from(document.querySelectorAll('#domainList tbody tr'));
                            const orderedData = tableRows.map(row => {
                                const domain = row.querySelector('td:nth-child(2)').textContent;
                                const info = domains[domain];
                                return [
                                    info.has_ssl ? 'Online' : 'Offline',
                                    domain,
                                    info.valid_from || 'N/A',
                                    info.valid_until || 'N/A',
                                    `${info.days_remaining || 'N/A'} d√≠as`,
                                    info.last_check,
                                    info.note ? info.note : 'Sin Observaciones.'
                                ];
                            });

                            doc.autoTable({
                                startY: 95,
                                head: [['Estado', 'Dominio', 'Desde', 'Hasta', 'D√≠as', '√ölt. verif', 'Obs.']],
                                body: orderedData,
                                theme: 'grid',
                                headStyles: {
                                    fillColor: [41, 128, 185],
                                    textColor: 255,
                                    fontSize: 6,
                                    halign: 'center'
                                },
                                styles: {
                                    fontSize: 6,
                                    cellPadding: 2,
                                    overflow: 'linebreak',
                                    halign: 'center'
                                },
                                columnStyles: {
                                    0: { cellWidth: 15, halign: 'center' },
                                    1: { cellWidth: 50, halign: 'center' }, 
                                    2: { cellWidth: 15, halign: 'center' }, 
                                    3: { cellWidth: 15, halign: 'center' }, 
                                    4: { cellWidth: 15, halign: 'center' }, 
                                    5: { cellWidth: 20, halign: 'center' },
                                    6: { cellWidth: 50, halign: 'center' }  
                                },
                                margin: { left: centerMargin, top: 40 }
                            });

                            // Add summary
                            const totalDomains = Object.keys(domains).length;
                            const validDomains = Object.values(domains).filter(info => info.has_ssl).length;
                            const expiringDomains = Object.values(domains).filter(info => info.days_remaining <= 30 && info.has_ssl).length;

                            const finalY = doc.lastAutoTable.finalY + 10;
                            doc.setFontSize(8);
                            doc.setTextColor(44, 62, 80);
                            doc.text('Resumen:', 14, finalY);
                            doc.setFontSize(8);
                            doc.text([
                                `‚Ä¢ Total de dominios monitoreados: ${totalDomains}`,
                                `‚Ä¢ Dominios con SSL v√°lido: ${validDomains}`,
                                `‚Ä¢ Dominios por vencer (30 d√≠as o menos): ${expiringDomains}`
                            ], 20, finalY + 7);

                            // Limpiar contenedores de canvas
                            document.body.removeChild(canvasContainer);

                            // Save PDF
                            doc.save(`reporte_ssl_${new Date().toISOString().split('T')[0]}.pdf`);
                        });
                    }, 1000); // Esperar 1 segundo para que los gr√°ficos se rendericen
                });
        }

        // Agregar detector de eventos para la tecla Enter
        document.getElementById('domainInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addDomain();
            }
        });

        // Funci√≥n para configurar el ordenamiento de tabla persistente
        function setupTableSorting() {
            const table = document.getElementById("domainList");
            const headers = table.querySelectorAll("th");
            const tbody = table.querySelector("tbody");

            // Recuperar estado del ordenamiento desde localStorage
            const savedSort = JSON.parse(localStorage.getItem("tableSort")) || {};

            // Aplicar el ordenamiento guardado al cargar la p√°gina
            if (savedSort.index !== undefined && savedSort.order) {
                // Marcar visualmente el encabezado con la direcci√≥n de ordenamiento
                headers[savedSort.index].dataset.order = savedSort.order;
                updateSortIndicators(headers, savedSort.index);
            }

            // Configurar listeners para los encabezados
            headers.forEach((header, index) => {
                header.addEventListener("click", () => {
                    // Alternar el orden: si no existe, establecer ascendente, si es ascendente cambiar a descendente, etc.
                    const currentOrder = header.dataset.order || '';
                    const newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
                    
                    // Actualizar el atributo de datos para el encabezado
                    header.dataset.order = newOrder;
                    
                    // Guardar estado en localStorage para persistencia
                    localStorage.setItem("tableSort", JSON.stringify({ index, order: newOrder }));
                    
                    // Aplicar el ordenamiento a la tabla
                    sortTable(tbody, index, newOrder);
                    
                    // Actualizar indicadores visuales
                    updateSortIndicators(headers, index);
                });
            });

            // Escuchar actualizaciones de la lista de dominios para reordenar despu√©s
            document.addEventListener('domainListUpdated', function() {
                if (savedSort.index !== undefined && savedSort.order) {
                    setTimeout(() => {
                        sortTable(tbody, savedSort.index, savedSort.order);
                    }, 100);
                }
            });
        }

        // Actualizar los indicadores visuales de ordenamiento
        function updateSortIndicators(headers, activeIndex) {
            headers.forEach((header, index) => {
                // Preservar texto original (sin indicadores)
                const originalText = header.textContent.replace(' ‚áÖ', '').replace(' ‚Üë', '').replace(' ‚Üì', '');
                
                if (index === activeIndex) {
                    const order = header.dataset.order;
                    header.textContent = originalText + (order === 'asc' ? ' ‚Üë' : ' ‚Üì');
                } else {
                    // Restaurar indicador neutral para encabezados que lo ten√≠an originalmente
                    if (originalText.includes('Dominio') || 
                        originalText.includes('V√°lido desde') || 
                        originalText.includes('V√°lido hasta') || 
                        originalText.includes('D√≠as rest') || 
                        originalText.includes('√ölt. verif')) {
                        header.textContent = originalText + ' ‚áÖ';
                    } else {
                        header.textContent = originalText;
                    }
                }
            });
        }

        // Funci√≥n para ordenar la tabla
        function sortTable(tbody, index, order) {
            const rows = Array.from(tbody.querySelectorAll("tr"));
            
            rows.sort((rowA, rowB) => {
                // Manejar caso especial para filas sin certificado SSL
                if (!rowA.children[index] || !rowB.children[index]) {
                    return 0;
                }
                
                const cellA = rowA.children[index].textContent.trim();
                const cellB = rowB.children[index].textContent.trim();
                
                return order === "asc" ? compareValues(cellA, cellB) : compareValues(cellB, cellA);
            });

            // Vaciar y reconstruir la tabla ordenada
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        }

        // Funci√≥n para comparar valores (num√©ricos o texto)
        function compareValues(a, b) {
            // Extraer n√∫meros de textos como "X d√≠as"
            if (a.includes('d√≠as') && b.includes('d√≠as')) {
                const numA = parseInt(a.match(/\d+/)[0]);
                const numB = parseInt(b.match(/\d+/)[0]);
                return numA - numB;
            }
            
            // Comparar fechas
            if (isDate(a) && isDate(b)) {
                return new Date(a) - new Date(b);
            }
            
            // Valores num√©ricos
            if (!isNaN(parseFloat(a)) && !isNaN(parseFloat(b))) {
                return parseFloat(a) - parseFloat(b);
            }
            
            // Ordenar texto normalmente
            return a.localeCompare(b, undefined, { numeric: true });
        }

        // Funci√≥n auxiliar para detectar fechas
        function isDate(value) {
            // Verifica patrones comunes de fecha como DD/MM/YYYY o YYYY-MM-DD
            return /^\d{1,2}[/.-]\d{1,2}[/.-]\d{2,4}$/.test(value) || 
                   /^\d{4}[/.-]\d{1,2}[/.-]\d{1,2}$/.test(value);
        }

        // Actualizar el a√±o autom√°ticamente
        document.getElementById('currentYear').textContent = new Date().getFullYear();
    </script>
</body>
</html>